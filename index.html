<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FaceTrack Pro - AI Attendance System</title>
    <style>
      /* GitHub-inspired Design System */
      :root {
        --color-canvas-default: #0d1117;
        --color-canvas-subtle: #161b22;
        --color-border-default: #30363d;
        --color-border-muted: #21262d;
        --color-fg-default: #e6edf3;
        --color-fg-muted: #7d8590;
        --color-accent-emphasis: #1f6feb;
        --color-success-emphasis: #238636;
        --color-attention-emphasis: #9e6a03;
        --color-danger-emphasis: #da3633;
        --color-btn-primary-bg: #238636;
        --color-btn-primary-hover: #2ea043;
        --color-btn-bg: #21262d;
        --color-btn-border: #30363d;
        --color-btn-hover-bg: #30363d;
        --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans",
          Helvetica, Arial, sans-serif;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-stack);
        background-color: var(--color-canvas-default);
        color: var(--color-fg-default);
        line-height: 1.5;
      }

      /* Header */
      .header {
        background-color: var(--color-canvas-subtle);
        border-bottom: 1px solid var(--color-border-default);
        padding: 16px 24px;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-content {
        max-width: 1280px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        font-weight: 600;
        color: var(--color-fg-default);
        text-decoration: none;
      }

      .logo::before {
        content: "👤";
        font-size: 24px;
      }

      .nav-menu {
        display: flex;
        gap: 24px;
        list-style: none;
      }

      .nav-link {
        color: var(--color-fg-muted);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
      }

      .nav-link:hover {
        color: var(--color-fg-default);
      }

      /* Main Container */
      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px;
      }

      /* Dashboard Grid */
      .dashboard {
        display: grid;
        grid-template-columns: 280px 1fr 320px;
        gap: 24px;
        margin-top: 24px;
      }

      /* Sidebar */
      .sidebar {
        background-color: var(--color-canvas-subtle);
        border: 1px solid var(--color-border-default);
        border-radius: 12px;
        padding: 24px;
        height: fit-content;
        position: sticky;
        top: 100px;
      }

      .sidebar-section {
        margin-bottom: 32px;
      }

      .sidebar-section:last-child {
        margin-bottom: 0;
      }

      .sidebar-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--color-fg-default);
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--color-border-muted);
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border: 1px solid var(--color-btn-border);
        border-radius: 6px;
        background-color: var(--color-btn-bg);
        color: var(--color-fg-default);
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
        justify-content: center;
        margin-bottom: 8px;
      }

      .btn:hover {
        background-color: var(--color-btn-hover-bg);
        border-color: var(--color-border-default);
      }

      .btn-primary {
        background-color: var(--color-btn-primary-bg);
        border-color: var(--color-btn-primary-bg);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--color-btn-primary-hover);
        border-color: var(--color-btn-primary-hover);
      }

      .btn-success {
        background-color: var(--color-success-emphasis);
        border-color: var(--color-success-emphasis);
        color: white;
      }

      .btn-danger {
        background-color: var(--color-danger-emphasis);
        border-color: var(--color-danger-emphasis);
        color: white;
      }

      /* Main Content */
      .main-content {
        background-color: var(--color-canvas-subtle);
        border: 1px solid var(--color-border-default);
        border-radius: 12px;
        overflow: hidden;
      }

      .content-header {
        padding: 24px;
        border-bottom: 1px solid var(--color-border-default);
        background-color: var(--color-canvas-default);
      }

      .content-title {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .content-subtitle {
        color: var(--color-fg-muted);
        font-size: 16px;
      }

      .content-body {
        padding: 24px;
      }

      /* Video Container */
      .video-container {
        position: relative;
        background-color: var(--color-canvas-default);
        border: 2px solid var(--color-border-default);
        border-radius: 8px;
        overflow: hidden;
        aspect-ratio: 16/9;
        margin-bottom: 24px;
      }

      .video-feed {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-overlay {
        position: absolute;
        top: 16px;
        left: 16px;
        background-color: rgba(13, 17, 23, 0.8);
        backdrop-filter: blur(8px);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
      }

      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-online {
        background-color: var(--color-success-emphasis);
      }

      .status-offline {
        background-color: var(--color-fg-muted);
      }

      /* Controls */
      .controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .control-group {
        flex: 1;
        min-width: 200px;
      }

      .control-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--color-fg-default);
      }

      .slider-container {
        position: relative;
      }

      .slider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: var(--color-border-default);
        outline: none;
        cursor: pointer;
      }

      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--color-accent-emphasis);
        cursor: pointer;
        border: 2px solid var(--color-canvas-default);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--color-accent-emphasis);
        cursor: pointer;
        border: 2px solid var(--color-canvas-default);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .slider-value {
        position: absolute;
        top: -32px;
        right: 0;
        background-color: var(--color-btn-bg);
        border: 1px solid var(--color-border-default);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      /* Attendance Panel */
      .attendance-panel {
        background-color: var(--color-canvas-subtle);
        border: 1px solid var(--color-border-default);
        border-radius: 12px;
        height: fit-content;
        position: sticky;
        top: 100px;
      }

      .panel-header {
        padding: 20px;
        border-bottom: 1px solid var(--color-border-default);
        background-color: var(--color-canvas-default);
        border-radius: 12px 12px 0 0;
      }

      .panel-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .panel-subtitle {
        color: var(--color-fg-muted);
        font-size: 14px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        padding: 20px;
      }

      .stat-card {
        background-color: var(--color-canvas-default);
        border: 1px solid var(--color-border-default);
        border-radius: 8px;
        padding: 16px;
        text-align: center;
      }

      .stat-number {
        font-size: 24px;
        font-weight: 700;
        color: var(--color-accent-emphasis);
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 12px;
        color: var(--color-fg-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Attendance List */
      .attendance-list {
        max-height: 400px;
        overflow-y: auto;
        padding: 0 20px 20px;
      }

      .attendance-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background-color: var(--color-canvas-default);
        border: 1px solid var(--color-border-default);
        border-radius: 6px;
        margin-bottom: 8px;
        transition: background-color 0.2s;
      }

      .attendance-item:hover {
        background-color: var(--color-btn-hover-bg);
      }

      .attendance-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(
          45deg,
          var(--color-accent-emphasis),
          var(--color-success-emphasis)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
      }

      .attendance-info {
        flex: 1;
      }

      .attendance-name {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 2px;
      }

      .attendance-time {
        font-size: 12px;
        color: var(--color-fg-muted);
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        backdrop-filter: blur(4px);
      }

      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: var(--color-canvas-subtle);
        border: 1px solid var(--color-border-default);
        border-radius: 12px;
        padding: 24px;
        max-width: 480px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        margin-bottom: 20px;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        color: var(--color-fg-muted);
        font-size: 24px;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: color 0.2s;
      }

      .modal-close:hover {
        color: var(--color-fg-default);
        background-color: var(--color-btn-hover-bg);
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--color-fg-default);
      }

      .form-input {
        width: 100%;
        padding: 8px 12px;
        background-color: var(--color-canvas-default);
        border: 1px solid var(--color-border-default);
        border-radius: 6px;
        color: var(--color-fg-default);
        font-size: 14px;
        font-family: inherit;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--color-accent-emphasis);
        box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.1);
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        .dashboard {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .sidebar,
        .attendance-panel {
          position: static;
        }
      }

      @media (max-width: 768px) {
        .container {
          padding: 16px;
        }

        .header-content {
          padding: 0 16px;
        }

        .nav-menu {
          display: none;
        }

        .controls {
          flex-direction: column;
        }
      }

      /* Animations */
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .recording {
        animation: pulse 2s infinite;
      }

      /* Custom Scrollbar */
      .attendance-list::-webkit-scrollbar {
        width: 6px;
      }

      .attendance-list::-webkit-scrollbar-track {
        background: var(--color-canvas-default);
      }

      .attendance-list::-webkit-scrollbar-thumb {
        background: var(--color-border-default);
        border-radius: 3px;
      }

      .attendance-list::-webkit-scrollbar-thumb:hover {
        background: var(--color-fg-muted);
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <a href="#" class="logo">FaceTrack Pro</a>
        <nav>
          <ul class="nav-menu">
            <li><a href="#" class="nav-link">Dashboard</a></li>
            <li><a href="#" class="nav-link">Students</a></li>
            <li><a href="#" class="nav-link">Reports</a></li>
            <li><a href="#" class="nav-link">Settings</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <!-- Main Container -->
    <div class="container">
      <!-- Dashboard Grid -->
      <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
          <!-- Camera Controls -->
          <div class="sidebar-section">
            <h3 class="sidebar-title">📹 Camera Controls</h3>
            <button id="startCamera" class="btn btn-primary">
              <span>▶️</span> Start Camera
            </button>
            <button
              id="stopCamera"
              class="btn btn-danger"
              style="display: none"
            >
              <span>⏹️</span> Stop Camera
            </button>
            <button id="registerStudent" class="btn">
              <span>➕</span> Register Student
            </button>
          </div>

          <!-- AI Settings -->
          <div class="sidebar-section">
            <h3 class="sidebar-title">🤖 AI Settings</h3>
            <div class="control-group">
              <label class="control-label">Recognition Confidence</label>
              <div class="slider-container">
                <input
                  type="range"
                  class="slider"
                  id="confidenceSlider"
                  min="30"
                  max="95"
                  value="70"
                  step="5"
                />
                <span class="slider-value" id="confidenceValue">70%</span>
              </div>
            </div>
          </div>

          <!-- Data Management -->
          <div class="sidebar-section">
            <h3 class="sidebar-title">📊 Data Management</h3>
            <button id="viewRecords" class="btn">
              <span>👁️</span> View All Records
            </button>
            <button id="exportData" class="btn">
              <span>📁</span> Export to CSV
            </button>
            <button id="viewStudents" class="btn">
              <span>👥</span> View Students
            </button>
          </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
          <div class="content-header">
            <h1 class="content-title">Live Recognition</h1>
            <p class="content-subtitle">
              AI-powered facial recognition for automatic attendance tracking
            </p>
          </div>
          <div class="content-body">
            <!-- Video Container -->
            <div class="video-container">
              <video
                id="videoFeed"
                class="video-feed"
                autoplay
                muted
                playsinline
              ></video>
              <div class="video-overlay">
                <span
                  class="status-indicator status-offline"
                  id="statusIndicator"
                ></span>
                <span id="statusText">Camera Offline</span>
              </div>
              <canvas
                id="overlayCanvas"
                style="
                  position: absolute;
                  top: 0;
                  left: 0;
                  pointer-events: none;
                "
              ></canvas>
            </div>

            <!-- Recognition Info -->
            <div class="controls">
              <div class="control-group">
                <label class="control-label">Last Recognition</label>
                <div
                  style="
                    padding: 12px;
                    background: var(--color-canvas-default);
                    border: 1px solid var(--color-border-default);
                    border-radius: 6px;
                  "
                >
                  <div id="lastRecognition" style="font-weight: 500">
                    Waiting for detection...
                  </div>
                  <div
                    id="lastConfidence"
                    style="
                      font-size: 12px;
                      color: var(--color-fg-muted);
                      margin-top: 4px;
                    "
                  >
                    Confidence: N/A
                  </div>
                </div>
              </div>
              <div class="control-group">
                <label class="control-label">System Status</label>
                <div
                  style="
                    padding: 12px;
                    background: var(--color-canvas-default);
                    border: 1px solid var(--color-border-default);
                    border-radius: 6px;
                  "
                >
                  <div id="systemStatus" style="font-weight: 500">
                    System Ready
                  </div>
                  <div
                    id="modelStatus"
                    style="
                      font-size: 12px;
                      color: var(--color-fg-muted);
                      margin-top: 4px;
                    "
                  >
                    Models loaded successfully
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>

        <!-- Attendance Panel -->
        <aside class="attendance-panel">
          <div class="panel-header">
            <h2 class="panel-title">Today's Attendance</h2>
            <p class="panel-subtitle" id="currentDate"></p>
          </div>

          <!-- Stats -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="presentCount">0</div>
              <div class="stat-label">Present</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalStudents">0</div>
              <div class="stat-label">Total</div>
            </div>
          </div>

          <!-- Attendance List -->
          <div class="attendance-list" id="attendanceList">
            <div
              style="
                text-align: center;
                padding: 40px 20px;
                color: var(--color-fg-muted);
              "
            >
              <div style="font-size: 48px; margin-bottom: 16px">📋</div>
              <div>No attendance records yet</div>
              <div style="font-size: 12px; margin-top: 8px">
                Start the camera to begin tracking
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeRegistrationModal()">
          &times;
        </button>
        <div class="modal-header">
          <h2 class="modal-title">Register New Student</h2>
          <p style="color: var(--color-fg-muted); font-size: 14px">
            Enter student details to begin registration process
          </p>
        </div>
        <form id="registrationForm">
          <div class="form-group">
            <label class="form-label">Student Full Name</label>
            <input
              type="text"
              class="form-input"
              id="studentName"
              placeholder="Enter full name"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">Student ID (Optional)</label>
            <input
              type="text"
              class="form-input"
              id="studentId"
              placeholder="Enter student ID"
            />
          </div>
          <div style="display: flex; gap: 12px; margin-top: 24px">
            <button
              type="button"
              class="btn"
              onclick="closeRegistrationModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              Start Registration
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Records Modal -->
    <div id="recordsModal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <button class="modal-close" onclick="closeRecordsModal()">
          &times;
        </button>
        <div class="modal-header">
          <h2 class="modal-title">Attendance Records</h2>
          <p style="color: var(--color-fg-muted); font-size: 14px">
            Complete attendance history
          </p>
        </div>
        <div id="recordsContent">
          <div
            style="
              text-align: center;
              padding: 40px;
              color: var(--color-fg-muted);
            "
          >
            <div style="font-size: 48px; margin-bottom: 16px">📊</div>
            <div>No records available</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // === Backend URL Configuration ===
      // Change this if your backend runs on a different host/port
      const BACKEND_URL = "http://127.0.0.1:5000";

      // Application State
      let isRecording = false;
      let stream = null;
      let attendanceData = [];
      let registeredStudents = [];
      let recognitionInterval = null;
      let confidenceThreshold = 0.7;

      // DOM Elements
      const videoFeed = document.getElementById("videoFeed");
      const statusIndicator = document.getElementById("statusIndicator");
      const statusText = document.getElementById("statusText");
      const startCameraBtn = document.getElementById("startCamera");
      const stopCameraBtn = document.getElementById("stopCamera");
      const registerStudentBtn = document.getElementById("registerStudent");
      const confidenceSlider = document.getElementById("confidenceSlider");
      const confidenceValue = document.getElementById("confidenceValue");
      const lastRecognition = document.getElementById("lastRecognition");
      const lastConfidence = document.getElementById("lastConfidence");
      const attendanceList = document.getElementById("attendanceList");
      const presentCount = document.getElementById("presentCount");
      const totalStudents = document.getElementById("totalStudents");
      const currentDate = document.getElementById("currentDate");
      const overlayCanvas = document.getElementById("overlayCanvas");

      // Initialize Application
      document.addEventListener("DOMContentLoaded", function () {
        initializeApp();
        setupEventListeners();
        updateDateTime();
        loadStoredData();
      });

      function initializeApp() {
        // Set current date
        const today = new Date();
        currentDate.textContent = today.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        // Initialize canvas
        const canvas = overlayCanvas;
        const video = videoFeed;
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
      }

      function setupEventListeners() {
        // Camera controls
        startCameraBtn.addEventListener("click", startCamera);
        stopCameraBtn.addEventListener("click", stopCamera);
        registerStudentBtn.addEventListener("click", openRegistrationModal);

        // Slider controls
        confidenceSlider.addEventListener("input", updateConfidenceThreshold);

        // Data management
        document
          .getElementById("viewRecords")
          .addEventListener("click", openRecordsModal);
        document
          .getElementById("exportData")
          .addEventListener("click", exportToCSV);
        document
          .getElementById("viewStudents")
          .addEventListener("click", viewStudents);

        // Registration form
        document
          .getElementById("registrationForm")
          .addEventListener("submit", startStudentRegistration);

        // Video events
        videoFeed.addEventListener("loadedmetadata", function () {
          overlayCanvas.width = videoFeed.videoWidth;
          overlayCanvas.height = videoFeed.videoHeight;
        });
      }

      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              width: { ideal: 1280 },
              height: { ideal: 720 },
              facingMode: "user",
            },
          });

          videoFeed.srcObject = stream;
          isRecording = true;

          // Update UI
          statusIndicator.className = "status-indicator status-online";
          statusText.textContent = "Camera Online";
          startCameraBtn.style.display = "none";
          stopCameraBtn.style.display = "block";

          // Start recognition
          startRecognition();

          console.log("Camera started successfully");
        } catch (error) {
          console.error("Error accessing camera:", error);
          alert("Could not access camera. Please check permissions.");
        }
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }

        videoFeed.srcObject = null;
        isRecording = false;

        // Update UI
        statusIndicator.className = "status-indicator status-offline";
        statusText.textContent = "Camera Offline";
        startCameraBtn.style.display = "block";
        stopCameraBtn.style.display = "none";

        // Stop recognition
        stopRecognition();

        // Clear canvas
        const ctx = overlayCanvas.getContext("2d");
        ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

        console.log("Camera stopped");
      }

      function startRecognition() {
        if (recognitionInterval) {
          clearInterval(recognitionInterval);
        }

        // Simulate face recognition every 2 seconds
        recognitionInterval = setInterval(() => {
          if (isRecording && videoFeed.videoWidth > 0) {
            performFaceRecognition();
          }
        }, 2000);
      }

      function stopRecognition() {
        if (recognitionInterval) {
          clearInterval(recognitionInterval);
          recognitionInterval = null;
        }
      }

      async function performFaceRecognition() {
        try {
          // Create canvas to capture video frame
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = videoFeed.videoWidth;
          canvas.height = videoFeed.videoHeight;

          // Draw current video frame
          ctx.drawImage(videoFeed, 0, 0);

          // Convert to blob and send to backend
          canvas.toBlob(
            async (blob) => {
              const formData = new FormData();
              formData.append("frame", blob);
              formData.append("confidence", confidenceThreshold);

              try {
                const response = await fetch(`${BACKEND_URL}/api/recognize`, {
                  method: "POST",
                  body: formData,
                });

                if (response.ok) {
                  const result = await response.json();
                  handleRecognitionResult(result);
                }
              } catch (error) {
                console.log(
                  "Recognition service not available, using demo mode"
                );
                simulateRecognition();
              }
            },
            "image/jpeg",
            0.8
          );
        } catch (error) {
          console.error("Recognition error:", error);
          simulateRecognition();
        }
      }

      function simulateRecognition() {
        // Demo mode - simulate recognition results
        const demoStudents = [
          "John Doe",
          "Jane Smith",
          "Mike Johnson",
          "Sarah Wilson",
          "David Brown",
        ];

        if (Math.random() > 0.7) {
          // 30% chance of recognition
          const randomStudent =
            demoStudents[Math.floor(Math.random() * demoStudents.length)];
          const confidence = 0.6 + Math.random() * 0.3; // 60-90% confidence

          const result = {
            recognized: true,
            name: randomStudent,
            confidence: confidence,
            bbox: {
              x: 100 + Math.random() * 200,
              y: 80 + Math.random() * 150,
              width: 120 + Math.random() * 80,
              height: 160 + Math.random() * 100,
            },
          };

          handleRecognitionResult(result);
        } else {
          // Show face detection without recognition
          drawFaceDetection(
            {
              x: 150 + Math.random() * 100,
              y: 100 + Math.random() * 100,
              width: 140,
              height: 180,
            },
            false
          );
        }
      }

      function handleRecognitionResult(result) {
        if (result.recognized && result.confidence >= confidenceThreshold) {
          // Update last recognition
          lastRecognition.textContent = result.name;
          lastConfidence.textContent = `Confidence: ${(
            result.confidence * 100
          ).toFixed(1)}%`;

          // Draw face detection box
          drawFaceDetection(result.bbox, true, result.name);

          // Mark attendance
          markAttendance(result.name);
        } else if (result.bbox) {
          // Draw detection box without recognition
          drawFaceDetection(result.bbox, false);
        }
      }

      function drawFaceDetection(bbox, recognized = false, name = "") {
        const ctx = overlayCanvas.getContext("2d");
        ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

        // Scale coordinates to canvas size
        const scaleX = overlayCanvas.width / videoFeed.videoWidth;
        const scaleY = overlayCanvas.height / videoFeed.videoHeight;

        const x = bbox.x * scaleX;
        const y = bbox.y * scaleY;
        const width = bbox.width * scaleX;
        const height = bbox.height * scaleY;

        // Draw rectangle
        ctx.strokeStyle = recognized ? "#238636" : "#1f6feb";
        ctx.lineWidth = 3;
        ctx.strokeRect(x, y, width, height);

        // Draw name label if recognized
        if (recognized && name) {
          ctx.fillStyle = recognized ? "#238636" : "#1f6feb";
          ctx.fillRect(x, y - 30, ctx.measureText(name).width + 20, 25);

          ctx.fillStyle = "white";
          ctx.font =
            "14px -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif";
          ctx.fillText(name, x + 10, y - 10);
        }
      }

      function markAttendance(studentName) {
        const today = new Date().toDateString();
        const now = new Date();

        // Check if already marked today
        const existingRecord = attendanceData.find(
          (record) => record.name === studentName && record.date === today
        );

        if (!existingRecord) {
          const attendanceRecord = {
            name: studentName,
            date: today,
            time: now.toLocaleTimeString(),
            timestamp: now.getTime(),
          };

          attendanceData.unshift(attendanceRecord);
          updateAttendanceUI();
          saveToStorage();

          // Show notification
          showNotification(`✅ ${studentName} marked present`);
        }
      }

      function updateAttendanceUI() {
        const today = new Date().toDateString();
        const todayAttendance = attendanceData.filter(
          (record) => record.date === today
        );

        // Update stats
        presentCount.textContent = todayAttendance.length;
        totalStudents.textContent =
          registeredStudents.length || todayAttendance.length;

        // Update list
        if (todayAttendance.length > 0) {
          attendanceList.innerHTML = "";
          todayAttendance.forEach((record) => {
            const item = createAttendanceItem(record);
            attendanceList.appendChild(item);
          });
        }
      }

      function createAttendanceItem(record) {
        const item = document.createElement("div");
        item.className = "attendance-item";

        const initials = record.name
          .split(" ")
          .map((n) => n[0])
          .join("")
          .toUpperCase();

        item.innerHTML = `
                <div class="attendance-avatar">${initials}</div>
                <div class="attendance-info">
                    <div class="attendance-name">${record.name}</div>
                    <div class="attendance-time">${record.time}</div>
                </div>
            `;

        return item;
      }

      function updateConfidenceThreshold() {
        confidenceThreshold = confidenceSlider.value / 100;
        confidenceValue.textContent = `${confidenceSlider.value}%`;
      }

      function updateDateTime() {
        setInterval(() => {
          const now = new Date();
          currentDate.textContent = now.toLocaleDateString("en-US", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        }, 60000); // Update every minute
      }

      // Modal Functions
      function openRegistrationModal() {
        document.getElementById("registrationModal").style.display = "block";
      }

      function closeRegistrationModal() {
        document.getElementById("registrationModal").style.display = "none";
        document.getElementById("registrationForm").reset();
      }

      function openRecordsModal() {
        const modal = document.getElementById("recordsModal");
        const content = document.getElementById("recordsContent");

        if (attendanceData.length > 0) {
          content.innerHTML = createRecordsTable();
        } else {
          content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-fg-muted);">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <div>No records available</div>
                        <div style="font-size: 12px; margin-top: 8px;">Start tracking to see attendance records</div>
                    </div>
                `;
        }

        modal.style.display = "block";
      }

      function closeRecordsModal() {
        document.getElementById("recordsModal").style.display = "none";
      }

      function createRecordsTable() {
        let html = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--color-canvas-default); border-bottom: 1px solid var(--color-border-default);">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Student</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Date</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Time</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

        attendanceData.forEach((record) => {
          html += `
                    <tr style="border-bottom: 1px solid var(--color-border-muted);">
                        <td style="padding: 12px;">${record.name}</td>
                        <td style="padding: 12px; color: var(--color-fg-muted);">${record.date}</td>
                        <td style="padding: 12px; color: var(--color-fg-muted);">${record.time}</td>
                    </tr>
                `;
        });

        html += "</tbody></table></div>";
        return html;
      }

      async function startStudentRegistration(event) {
        event.preventDefault();

        const name = document.getElementById("studentName").value.trim();
        const studentId = document.getElementById("studentId").value.trim();

        if (!name) {
          alert("Please enter a student name");
          return;
        }

        // Check if student already exists
        if (registeredStudents.some((student) => student.name === name)) {
          if (
            !confirm(
              `Student "${name}" already exists. Do you want to re-register?`
            )
          ) {
            return;
          }
        }

        closeRegistrationModal();

        // Start registration process
        showNotification(`📸 Starting registration for ${name}...`);

        try {
          // In a real implementation, this would capture multiple face samples
          // and send them to the backend for training
          // await simulateRegistration(name, studentId);
          // Real backend registration
          const response = await fetch(`${BACKEND_URL}/api/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: name, id: studentId }),
          });
          if (response.ok) {
            const result = await response.json();
            showNotification(`✅ ${name} registered successfully!`);
            // Optionally update registeredStudents from backend
            fetchStudentsFromBackend();
          } else {
            const error = await response.json();
            showNotification(
              `❌ Registration failed for ${name}: ${
                error.error || error.message
              }`
            );
          }
        } catch (error) {
          console.error("Registration error:", error);
          showNotification(`❌ Registration failed for ${name}`);
        }
      }

      function viewStudents() {
        // Fetch students from backend
        fetchStudentsFromBackend(true);
      }

      async function fetchStudentsFromBackend(showAlert = false) {
        try {
          const response = await fetch(`${BACKEND_URL}/api/students`);
          if (response.ok) {
            const data = await response.json();
            registeredStudents = data.students || [];
            if (showAlert) {
              if (registeredStudents.length === 0) {
                alert(
                  "No students registered yet. Please register students first."
                );
                return;
              }
              let studentList = "Registered Students:\n\n";
              registeredStudents.forEach((student, index) => {
                studentList += `${index + 1}. ${student.name}`;
                if (student.id) studentList += ` (ID: ${student.id})`;
                studentList += `\n   Registered: ${new Date(
                  student.registered_at || student.registeredAt
                ).toLocaleDateString()}`;
                studentList += `\n   Samples: ${
                  student.samples_count || student.samples
                }\n\n`;
              });
              alert(studentList);
            }
            updateAttendanceUI();
          }
        } catch (error) {
          console.error("Error fetching students from backend:", error);
        }
      }

      function exportToCSV() {
        if (attendanceData.length === 0) {
          alert("No attendance data to export");
          return;
        }

        const csvContent = generateCSV();
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");

        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute(
            "download",
            `FaceTrack_Attendance_${new Date().toISOString().split("T")[0]}.csv`
          );
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          showNotification("📁 Attendance data exported successfully!");
        }
      }

      function generateCSV() {
        let csv = "Student Name,Date,Time,Timestamp\n";

        attendanceData.forEach((record) => {
          csv += `"${record.name}","${record.date}","${
            record.time
          }","${new Date(record.timestamp).toISOString()}"\n`;
        });

        return csv;
      }

      function showNotification(message) {
        // Create notification element
        const notification = document.createElement("div");
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--color-success-emphasis);
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                font-weight: 500;
                z-index: 1001;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease-out;
            `;
        notification.textContent = message;

        // Add animation keyframes
        if (!document.querySelector("#notification-styles")) {
          const style = document.createElement("style");
          style.id = "notification-styles";
          style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
          document.head.appendChild(style);
        }

        document.body.appendChild(notification);

        // Remove after 3 seconds
        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease-in";
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }

      function saveToStorage() {
        localStorage.setItem("attendanceData", JSON.stringify(attendanceData));
        localStorage.setItem(
          "registeredStudents",
          JSON.stringify(registeredStudents)
        );
      }

      function loadStoredData() {
        try {
          const storedAttendance = localStorage.getItem("attendanceData");
          const storedStudents = localStorage.getItem("registeredStudents");

          if (storedAttendance) {
            attendanceData = JSON.parse(storedAttendance);
          }

          if (storedStudents) {
            registeredStudents = JSON.parse(storedStudents);
          }

          updateAttendanceUI();
        } catch (error) {
          console.error("Error loading stored data:", error);
        }
      }

      // Close modals when clicking outside
      window.addEventListener("click", function (event) {
        const registrationModal = document.getElementById("registrationModal");
        const recordsModal = document.getElementById("recordsModal");

        if (event.target === registrationModal) {
          closeRegistrationModal();
        }

        if (event.target === recordsModal) {
          closeRecordsModal();
        }
      });

      // Handle page visibility changes
      document.addEventListener("visibilitychange", function () {
        if (document.hidden && isRecording) {
          console.log("Page hidden, pausing recognition");
          stopRecognition();
        } else if (!document.hidden && isRecording) {
          console.log("Page visible, resuming recognition");
          startRecognition();
        }
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", function () {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
        }
      });
    </script>
  </body>
</html>
